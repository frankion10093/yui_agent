# Yui Agent 项目总结文档

## 📋 项目概述

**项目名称**: yui_agent  
**项目类型**: 基于 LangChain 的智能 Agent 系统  
**主要功能**: 结合大语言模型（LLM）和多种工具，实现智能对话、QQ 机器人、B站直播互动等功能  
**开发语言**: Python 3.10  
**核心框架**: LangChain, LangGraph  

## 🎯 项目定位

这是一个多功能的 AI Agent 系统，主要特点：
- 支持多种 LLM 后端（Ollama 本地模型、SiliconFlow 云端 API）
- 集成 QQ 机器人功能（基于 NapCat 协议）
- 支持 B 站直播互动
- 提供本地工具调用能力
- 使用线程池管理异步任务

## 📁 项目结构

```
yui_agent/
├── Agent/                      # 主代码目录
│   ├── config/                 # 配置文件目录
│   │   ├── llm_config.yaml    # LLM 模型配置（Ollama/SiliconFlow）
│   │   ├── napcat_config.yaml # QQ 机器人配置
│   │   └── live_config.yaml   # 直播配置
│   │
│   ├── llm/                    # 大语言模型模块
│   │   ├── __init__.py        # 模块导出
│   │   ├── advent.py          # Agent 核心类实现
│   │   └── build_llm.py       # LLM 构建器（支持 Ollama 和 SiliconFlow）
│   │
│   ├── qq/                     # QQ 机器人模块
│   │   ├── __init__.py
│   │   └── qq_manager.py      # QQ 消息管理器（消息监听/发送/解析）
│   │
│   ├── tools/                  # 工具集模块
│   │   ├── __init__.py
│   │   ├── local_tool.py      # 本地工具（天气查询、鼠标控制、B站直播等）
│   │   └── qq_tool.py         # QQ 工具（消息发送、禁言、群公告等）
│   │
│   ├── plugin/                 # 插件系统
│   │   ├── jmcomic_plugin/    # 禁漫天堂漫画下载插件
│   │   └── live_plugin/       # B站直播插件
│   │
│   ├── thread_pool_manager/   # 线程池管理器
│   │   ├── __init__.py
│   │   └── thread_manager.py  # 前台/后台线程池管理
│   │
│   ├── utils/                  # 工具类
│   │   ├── __init__.py
│   │   └── logger_config.py   # 彩色日志配置
│   │
│   ├── test/                   # 测试目录
│   │   └── test_request.py
│   │
│   ├── main.py                 # 主程序入口（异步模式）
│   ├── qq_main.py              # QQ 机器人主程序
│   ├── local.py                # 本地测试入口
│   ├── ceshi.py                # 并发测试脚本
│   ├── requirment.txt          # 依赖包列表
│   └── buid.txt                # 构建说明
│
├── .gitignore                  # Git 忽略配置
└── README.md                   # 项目说明
```

## 🔧 核心模块详解

### 1. LLM 模块 (`llm/`)

#### `advent.py` - Agent 核心类
```python
class Advent:
    - 初始化 Agent 实例，加载配置和工具
    - 支持自定义工具集（LocalTools / QQTools）
    - 支持切换不同 LLM 后端
    - 管理聊天历史
```

**主要功能**：
- 构建基于 LangChain 的 Agent
- 加载系统提示词（当前角色：猫娘）
- 消息流式处理
- 与 QQ 消息队列集成

#### `build_llm.py` - LLM 构建器
支持两种 LLM 后端：
- **Ollama**: 本地部署模型（如 `gpt-oss:20b`）
- **SiliconFlow**: 云端 API（如 `deepseek-ai/DeepSeek-V3.2`）

配置读取自 `config/llm_config.yaml`

### 2. QQ 模块 (`qq/`)

#### `qq_manager.py` - QQ 消息管理器
基于 **NapCat 协议**（OneBot11 标准）实现 QQ 机器人功能

**核心功能**：
```python
class QQManager:
    - start_listen()              # WebSocket 监听消息
    - build_message()             # 构建消息（群聊/私聊）
    - send_request()              # 发送 HTTP 请求到 NapCat
    - parse_group_message_to_log() # 解析消息为日志格式
```

**消息队列**：使用 `queue.Queue` 存储待处理消息（最大 1000 条）

### 3. 工具模块 (`tools/`)

#### `local_tool.py` - 本地工具集
使用 `@tool` 装饰器定义 LangChain 工具：
- `get_weather_for_location(city)` - 获取城市天气
- `mouse_move(x, y)` - 鼠标控制
- `bilibili_live(is_live)` - 开启/关闭 B 站直播
- `open_app(app_name)` - 打开应用程序
- `get_time()` - 获取当前时间

#### `qq_tool.py` - QQ 工具集
- `send_qq_message()` - 发送消息（支持 at、文本、图片等）
- `qq_utils()` - QQ 功能（禁言、群公告）
- `get_plugin()` - 调用插件（如漫画下载）
- `get_back_thread_pool()` - 查看后台线程池状态

### 4. 线程池管理器 (`thread_pool_manager/`)

#### `thread_manager.py` - 双线程池架构
```python
class ThreadPoolManager:
    - front_executor (4 workers)  # 前台线程池
    - back_executor (6 workers)   # 后台线程池
```

**功能**：
- 任务提交和管理
- 任务状态监控
- 自动清理和资源释放
- 任务详情查询

### 5. 插件系统 (`plugin/`)

#### `jmcomic_plugin/` - 漫画下载插件
- 基于 `jmcomic` 库实现
- 支持后台异步下载

#### `live_plugin/BilibiliLive.py` - B站直播插件
- WebSocket 连接 B 站直播间
- 消息监听和解析

### 6. 工具类 (`utils/`)

#### `logger_config.py` - 彩色日志系统
```python
- DEBUG    → 天蓝色
- INFO     → 绿色
- WARNING  → 黄色
- ERROR    → 红色
- CRITICAL → 洋红色
```

支持控制台彩色输出和文件日志分割。

## ⚙️ 配置文件说明

### `llm_config.yaml` - LLM 配置
```yaml
llm:
  ollama:
    base_url: http://192.168.31.100:11434
    model: gpt-oss:20b
    temperature: 0.6
    keep_alive: 120
    timeout: 60
    
  siliconflow:
    base_url: https://api.siliconflow.cn/v1
    model: deepseek-ai/DeepSeek-V3.2
    api_key: sk-xxx...
    temperature: 0.6

system_prompts:
  猫娘: |
    你是拟人化的猫娘助手...
```

### `napcat_config.yaml` - QQ 机器人配置
- WebSocket 连接地址
- HTTP API 地址
- 消息类型路径映射

### `live_config.yaml` - 直播配置
（具体内容未提供）

## 🚀 运行方式

### 1. 环境搭建
```bash
# 参考 buid.txt
conda create -n agent python=3.10 -y
conda activate agent
pip install -r requirment.txt
```

### 2. 主要入口

#### QQ 机器人模式
```python
# qq_main.py
python qq_main.py
```
- 前台线程：监听 QQ 消息
- 后台线程：AI 处理和回复

#### 本地测试模式
```python
# local.py
python local.py
```
- 命令行交互模式
- 支持 WebSocket 连接测试

#### 异步 Agent 模式
```python
# main.py
python main.py
```
- 基于 asyncio 的异步运行

#### 并发压力测试
```python
# ceshi.py
python ceshi.py
```
- 5 个线程池并发测试
- 验证 Agent 多线程稳定性

## 📦 依赖关系

### 核心依赖
```
langchain==1.2.0          # LangChain 框架
langchain-core==1.2.3
langchain-ollama==1.0.1   # Ollama 集成
langchain-openai==1.1.6   # OpenAI API 集成
langgraph==1.0.5          # LangGraph 图结构
```

### 其他依赖
```
websocket-client==1.9.0   # WebSocket 支持
requests==2.32.5          # HTTP 请求
PyYAML==6.0.3             # YAML 配置解析
jmcomic==2.6.10           # 漫画下载
PyAutoGUI==0.9.54         # 鼠标控制
colorama==0.4.6           # 彩色输出
```

## 🎨 系统特点

### 1. 灵活的 LLM 支持
- 本地模型（Ollama）：隐私安全、无网络依赖
- 云端 API（SiliconFlow）：性能强大、快速响应
- 轻松切换后端

### 2. 模块化设计
- 清晰的模块划分
- 插件化工具系统
- 易于扩展新功能

### 3. 异步并发处理
- 前后台双线程池
- 消息队列缓冲
- 任务状态管理

### 4. QQ 机器人能力
- 群聊/私聊消息处理
- 多种消息类型支持（文本、at、图片等）
- 管理功能（禁言、公告）

### 5. 工具调用能力
- LangChain 工具封装
- 自动参数解析
- 错误处理和重试

## 📊 数据流程

```
用户消息（QQ）
    ↓
WebSocket 监听（qq_manager）
    ↓
消息队列（msg_queue）
    ↓
Agent 处理（Advent.chat）
    ↓
LLM 推理（Ollama/SiliconFlow）
    ↓
工具调用（send_qq_message）
    ↓
HTTP 请求（NapCat API）
    ↓
消息发送到 QQ
```

## 🛠️ 开发建议

### 当前存在的问题
1. **配置文件硬编码**：部分 IP 地址和 API Key 直接写在配置文件中
2. **错误处理不完善**：部分异常捕获过于宽泛
3. **日志文件未配置**：`logger_config.py` 只配置了控制台输出
4. **测试覆盖不足**：缺少单元测试

### 优化方向
1. **环境变量管理**：使用 `.env` 文件存储敏感信息
2. **配置校验**：启动时检查配置文件完整性
3. **监控面板**：添加 Web 界面查看运行状态
4. **性能优化**：消息批量处理、连接池复用
5. **文档完善**：补充 API 文档和使用示例

## 🔐 安全注意事项

1. **API Key 保护**：
   - 不要将配置文件提交到 Git（已在 `.gitignore` 中配置）
   - 使用示例配置文件（`example.ini`）

2. **WebSocket 安全**：
   - 建议使用 SSL/TLS 加密连接
   - 验证来源防止 CSRF

3. **权限控制**：
   - QQ 机器人操作添加权限验证
   - 敏感功能（禁言）添加管理员白名单

## 📈 扩展方向

### 短期目标
- [ ] 完善日志系统（文件输出、日志分割）
- [ ] 添加更多 QQ 功能（撤回消息、戳一戳）
- [ ] 优化消息解析（支持图片、语音）

### 中期目标
- [ ] 接入更多 LLM 提供商（通义千问、文心一言）
- [ ] 实现对话上下文管理
- [ ] 添加 Web 管理后台

### 长期目标
- [ ] 支持多平台（微信、Discord、Telegram）
- [ ] 实现 Agent 协作（多 Agent 系统）
- [ ] 添加知识库（RAG 检索增强）

## 📝 总结

Yui Agent 是一个功能丰富、架构清晰的智能 Agent 项目，具备以下亮点：

✅ **技术栈先进**：基于 LangChain/LangGraph 框架  
✅ **功能完整**：涵盖 QQ 机器人、直播互动、工具调用  
✅ **扩展性强**：插件化设计，易于添加新功能  
✅ **并发能力**：线程池管理，支持高并发场景  

适合用于：
- 学习 LangChain Agent 开发
- 构建自定义 QQ 机器人
- 多工具集成的智能助手
- AI Agent 系统原型开发

---

**文档生成时间**: 2025年12月23日  
**项目路径**: `d:\ProgreamCreate\Code\Git\yui_agent`  
**Python 版本**: 3.10+  
**主要框架**: LangChain 1.2.0
